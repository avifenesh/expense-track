name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
       - "src/**"
       - "tests/**"
       - "package.json"
       - "tsconfig.json"
       - ".github/workflows/**"
  push:
    tags:
      - '*'

jobs:
  check-run-count:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    permissions:
      actions: read
      pull-requests: read
    steps:
      - name: Check if workflow should run
        id: check
        run: |
          # Run on tag pushes
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For PRs, count previous successful/completed runs of this workflow
          PR_NUMBER="${{ github.event.pull_request.number }}"
          # Extract workflow filename from workflow_ref
          # Example: "owner/repo/.github/workflows/claude-code-review.yml@refs/heads/main"
          WORKFLOW_NAME=$(basename "${{ github.workflow_ref }}" | sed 's/@.*//')
          
          # Validate workflow name
          if [ -z "$WORKFLOW_NAME" ]; then
            echo "Error: Could not extract workflow name"
            echo "Defaulting to skip execution for safety"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Workflow name: $WORKFLOW_NAME"
          
          # URL encode the workflow name
          ENCODED_WORKFLOW_NAME=$(echo "$WORKFLOW_NAME" | jq -sRr @uri)
          
          # Query GitHub API for previous runs, with error handling
          API_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$ENCODED_WORKFLOW_NAME/runs?event=pull_request&status=completed")
          
          HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$API_RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: API request failed with status $HTTP_CODE"
            echo "Defaulting to skip execution for safety"
            RUN_COUNT=999
          else
            # Count runs for this specific PR and workflow
            RUN_COUNT=$(echo "$RESPONSE_BODY" | jq --arg wf "$WORKFLOW_NAME" --argjson pr "$PR_NUMBER" \
              '[.workflow_runs[] | select(.name == $wf and (.pull_requests[]?.number == $pr))] | length' 2>/dev/null || echo "999")
            
            # Validate RUN_COUNT is a number
            if ! [[ "$RUN_COUNT" =~ ^[0-9]+$ ]]; then
              echo "Error: Invalid RUN_COUNT value: $RUN_COUNT"
              echo "Defaulting to skip execution for safety"
              RUN_COUNT=999
            fi
          fi
          
          echo "Previous completed runs for this PR: $RUN_COUNT"
          
          # Run only on first 2 times (0 and 1 previous runs)
          if [ "$RUN_COUNT" -lt 2 ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping run - workflow has already run $RUN_COUNT times for this PR"
          fi

  claude-review:
    needs: check-run-count
    if: needs.check-run-count.outputs.should_run == 'true'
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'
          prompt: '/code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}'
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options

