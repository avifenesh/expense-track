// ==============================================================================
// DECIMAL PRECISION STANDARDS
// ==============================================================================
// Monetary amounts (Transaction.amount, Budget.planned, SharedExpense.totalAmount):
//   Decimal(12, 2) - 12 total digits, 2 decimal places
//   Range: -9,999,999,999.99 to 9,999,999,999.99
//   Use case: Standard currency amounts
//
// Asset quantities (Holding.quantity):
//   Decimal(18, 6) - 18 total digits, 6 decimal places
//   Range: supports fractional shares and cryptocurrency
//   Use case: Stock shares, crypto holdings with high precision
//
// Asset prices (Holding.averageCost):
//   Decimal(12, 2) - 12 total digits, 2 decimal places
//   Use case: Cost basis per share/unit in standard currency
//
// Percentages (ExpenseParticipant.sharePercentage):
//   Decimal(5, 2) - 5 total digits, 2 decimal places
//   Range: 0.00 to 999.99 (allows >100% for edge cases)
//   Use case: Percentage splits in expense sharing
// ==============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String    @id @default(cuid())
  email                    String    @unique
  displayName              String
  passwordHash             String
  preferredCurrency        Currency  @default(USD)
  emailVerified            Boolean   @default(false)
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?
  passwordResetToken       String?   @unique
  passwordResetExpires     DateTime?
  hasCompletedOnboarding   Boolean   @default(false)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  accounts              Account[]
  categories            Category[]
  refreshTokens         RefreshToken[]
  subscription          Subscription?
  sharedExpensesOwned   SharedExpense[]        @relation("SharedExpensesOwned")
  expenseParticipations ExpenseParticipant[]   @relation("ExpenseParticipations")

  @@index([email])
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  status               SubscriptionStatus @default(TRIALING)
  trialEndsAt          DateTime
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  canceledAt           DateTime?
  paddleCustomerId     String?
  paddleSubscriptionId String?            @unique
  paddlePriceId        String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([trialEndsAt])
  @@index([currentPeriodEnd])
}

model Account {
  id                 String               @id @default(cuid())
  userId             String
  name               String
  type               AccountType
  preferredCurrency  Currency?
  color              String?
  icon               String?
  description        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  deletedAt          DateTime?
  deletedBy          String?

  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  budgets            Budget[]
  holdings           Holding[]
  recurringTemplates RecurringTemplate[]
  transactions       Transaction[]
  sentRequests       TransactionRequest[] @relation("SentRequests")
  receivedRequests   TransactionRequest[] @relation("ReceivedRequests")

  @@unique([userId, name])
  @@index([userId])
  @@index([deletedAt])
}

model Budget {
  id         String    @id @default(cuid())
  accountId  String
  categoryId String
  month      DateTime
  planned    Decimal   @db.Decimal(12, 2)
  currency   Currency  @default(USD)
  notes      String?
  deletedAt  DateTime?
  deletedBy  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  account    Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category   Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([accountId, categoryId, month])
  @@index([month])
  @@index([accountId, month])
  @@index([deletedAt])
}

model Category {
  id                  String               @id @default(cuid())
  userId              String
  name                String
  type                TransactionType
  color               String?
  isHolding           Boolean              @default(false)
  isArchived          Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  budgets             Budget[]
  holdings            Holding[]
  recurringTemplates  RecurringTemplate[]
  transactions        Transaction[]
  transactionRequests TransactionRequest[]

  @@unique([userId, name, type])
  @@index([userId])
}

model DashboardCache {
  id                String    @id @default(cuid())
  cacheKey          String    @unique
  data              Json
  monthKey          String
  accountId         String?
  preferredCurrency Currency?
  fetchedAt         DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([monthKey, accountId])
  @@index([accountId])
  @@index([fetchedAt])
  @@index([monthKey])
}

model ExchangeRate {
  id             String   @id @default(cuid())
  baseCurrency   Currency
  targetCurrency Currency
  rate           Decimal  @db.Decimal(12, 6)
  date           DateTime
  fetchedAt      DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([baseCurrency, targetCurrency, date])
  @@index([fetchedAt])
}

model Holding {
  id          String    @id @default(cuid())
  accountId   String
  categoryId  String
  symbol      String
  quantity    Decimal   @db.Decimal(18, 6)
  averageCost Decimal   @db.Decimal(12, 2)
  currency    Currency  @default(USD)
  notes       String?
  deletedAt   DateTime?
  deletedBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([accountId, categoryId, symbol])
  @@index([accountId])
  @@index([categoryId])
  @@index([deletedAt])
}

model RecurringTemplate {
  id           String          @id @default(cuid())
  accountId    String
  categoryId   String
  type         TransactionType
  amount       Decimal         @db.Decimal(12, 2)
  currency     Currency        @default(USD)
  dayOfMonth   Int
  description  String?
  isActive     Boolean         @default(true)
  startMonth   DateTime
  endMonth     DateTime?
  deletedAt    DateTime?
  deletedBy    String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  account      Account         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category     Category        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([isActive])
  @@index([accountId])
  @@index([accountId, isActive])
  @@index([deletedAt])
}

model StockPrice {
  id            String   @id @default(cuid())
  symbol        String
  price         Decimal  @db.Decimal(12, 4)
  currency      Currency @default(USD)
  changePercent Decimal? @db.Decimal(8, 4)
  volume        BigInt?
  fetchedAt     DateTime @default(now())
  source        String   @default("alphavantage")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([symbol, fetchedAt])
  @@index([symbol, fetchedAt(sort: Desc)])
}

model Transaction {
  id                  String             @id @default(cuid())
  accountId           String
  categoryId          String
  type                TransactionType
  amount              Decimal            @db.Decimal(12, 2)
  date                DateTime
  month               DateTime
  description         String?
  isRecurring         Boolean            @default(false)
  isMutual            Boolean            @default(false)
  recurringTemplateId String?
  currency            Currency           @default(USD)
  deletedAt           DateTime?
  deletedBy           String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  account             Account            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category            Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  recurringTemplate   RecurringTemplate? @relation(fields: [recurringTemplateId], references: [id], onDelete: SetNull)
  sharedExpense       SharedExpense?

  @@index([accountId, month])
  @@index([month])
  @@index([date])
  @@index([deletedAt])
}

model SharedExpense {
  id            String               @id @default(cuid())
  transactionId String               @unique
  ownerId       String
  splitType     SplitType            @default(EQUAL)
  totalAmount   Decimal              @db.Decimal(12, 2)
  currency      Currency             @default(USD)
  description   String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  transaction   Transaction          @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  owner         User                 @relation("SharedExpensesOwned", fields: [ownerId], references: [id], onDelete: Cascade)
  participants  ExpenseParticipant[]

  @@index([ownerId])
  @@index([createdAt])
  @@index([ownerId, createdAt]) // Composite index for owner's expenses sorted by date
}

model ExpenseParticipant {
  id              String        @id @default(cuid())
  sharedExpenseId String
  userId          String
  shareAmount     Decimal       @db.Decimal(12, 2)
  sharePercentage Decimal?      @db.Decimal(5, 2)
  status          PaymentStatus @default(PENDING)
  paidAt          DateTime?
  declinedAt      DateTime?
  declineReason   String?
  reminderSentAt  DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  sharedExpense   SharedExpense @relation(fields: [sharedExpenseId], references: [id], onDelete: Cascade)
  participant     User          @relation("ExpenseParticipations", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sharedExpenseId, userId])
  @@index([userId])
  @@index([status])
  @@index([userId, status])
}

enum SplitType {
  EQUAL
  PERCENTAGE
  FIXED
}

enum PaymentStatus {
  PENDING
  PAID
  DECLINED
}
model TransactionRequest {
  id          String        @id @default(cuid())
  fromId      String
  toId        String
  categoryId  String
  amount      Decimal       @db.Decimal(12, 2)
  currency    Currency      @default(USD)
  date        DateTime
  description String?
  status      RequestStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  category    Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  from        Account       @relation("SentRequests", fields: [fromId], references: [id], onDelete: Cascade)
  to          Account       @relation("ReceivedRequests", fields: [toId], references: [id], onDelete: Cascade)

  @@index([toId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  jti       String   @unique
  userId    String
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([jti])
  @@index([expiresAt])
  @@index([expiresAt, userId]) // Composite index for expired token cleanup queries
}

enum AccountType {
  SELF
  PARTNER
  OTHER
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Currency {
  USD
  EUR
  ILS
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}
